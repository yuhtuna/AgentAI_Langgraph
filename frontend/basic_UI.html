<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI App Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .node {
            transition: all 0.3s ease;
        }
        .node.running {
            background-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 15px #3b82f6;
        }
        .node.completed {
            background-color: #22c55e; /* green-500 */
        }
        .node.failed {
            background-color: #ef4444; /* red-500 */
        }
        .node-connector {
            position: absolute;
            height: 2px;
            background-color: #4b5563; /* gray-600 */
            top: 50%;
            left: 12.5%;
            width: 75%;
            transform: translateY(-50%);
            z-index: -1;
        }
        .sidebar-icon.active {
            background-color: #7c3aed;
            color: white;
        }
        /* Custom radio button card */
        .app-type-card {
            border: 2px solid #4b5563;
            transition: all 0.2s ease-in-out;
        }
        input[type="radio"]:checked + .app-type-card {
            border-color: #7c3aed;
            background-color: rgba(124, 58, 237, 0.2);
            transform: scale(1.05);
        }
        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            line-height: 1.25rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .task-item {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex h-screen overflow-hidden">

    <!-- Left Sidebar: Project History -->
    <aside class="w-64 bg-gray-900/50 p-4 flex flex-col border-r border-gray-700 flex-shrink-0">
        <div class="flex items-center mb-6">
            <img src="https://placehold.co/40x40/7c3aed/ffffff?text=B" alt="Logo" class="rounded-lg mr-3">
            <h1 class="text-xl font-bold">AI App Builder</h1>
        </div>
        <button id="new-project-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center mb-6 transition-colors">
            <i data-lucide="plus" class="w-4 h-4 mr-2"></i> New Project
        </button>
        <div class="flex-grow overflow-y-auto pr-2">
            <h2 class="text-sm font-semibold text-gray-400 mb-2">RECENT PROJECTS</h2>
            <nav class="space-y-2">
                <a href="#" class="block bg-gray-700/50 p-3 rounded-lg">
                    <p class="font-semibold">Marketing Strategy App</p>
                    <p class="text-xs text-gray-400">Last updated: July 10, 2025</p>
                </a>
                <a href="#" class="block hover:bg-gray-800 p-3 rounded-lg">
                    <p class="font-semibold">Inventory Tracker</p>
                    <p class="text-xs text-gray-400">Last updated: July 8, 2025</p>
                </a>
            </nav>
        </div>
        <button class="text-gray-400 hover:text-white flex items-center mt-4">
            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i> Clear projects
        </button>
    </aside>

    <!-- Main Content Area (Workspace) -->
    <main id="main-workspace" class="flex-1 flex flex-col p-4 md:p-6 lg:p-8 overflow-y-auto">
        <!-- Content will be injected here by JS -->
    </main>

    <!-- Right Toolbar -->
    <nav class="w-16 bg-gray-900 flex flex-col items-center py-4 space-y-4 border-l border-gray-700">
        <button data-panel="chat" class="sidebar-icon p-3 rounded-lg text-gray-400 hover:bg-purple-600 hover:text-white transition-colors">
            <i data-lucide="message-square" class="w-6 h-6"></i>
        </button>
        <button data-panel="workflow" class="sidebar-icon p-3 rounded-lg text-gray-400 hover:bg-purple-600 hover:text-white transition-colors">
            <i data-lucide="git-merge" class="w-6 h-6"></i>
        </button>
        <button data-panel="preview" class="sidebar-icon p-3 rounded-lg text-gray-400 hover:bg-purple-600 hover:text-white transition-colors">
            <i data-lucide="eye" class="w-6 h-6"></i>
        </button>
        <button data-panel="code" class="sidebar-icon p-3 rounded-lg text-gray-400 hover:bg-purple-600 hover:text-white transition-colors">
            <i data-lucide="code-2" class="w-6 h-6"></i>
        </button>
        <button data-panel="usage" class="sidebar-icon p-3 rounded-lg text-gray-400 hover:bg-purple-600 hover:text-white transition-colors">
            <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
        </button>
    </nav>

    <!-- Panel Templates -->
    <template id="template-new-project">
        <div class="flex flex-col items-center py-8">
            <div class="w-full max-w-4xl text-center">
                <i data-lucide="rocket" class="w-16 h-16 mx-auto text-purple-400 mb-4"></i>
                <h2 class="text-3xl font-bold mb-2">Create a New Application</h2>
                <p class="text-gray-400 mb-6">Describe your application and select the required components. Our AI agents will build it for you.</p>
                
                <div class="glassmorphism p-4 rounded-lg mb-6 text-left">
                    <h3 class="text-lg font-semibold mb-2 ml-2">App Description</h3>
                    <textarea id="app-description" class="w-full bg-transparent p-2 text-lg focus:outline-none resize-none" rows="4" placeholder="e.g., An app that tracks my daily water intake and reminds me to drink more..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                    <!-- Left Column -->
                    <div class="space-y-6">
                        <div>
                            <div class="flex items-center mb-3">
                                <h3 class="text-lg font-semibold text-left">Application Type</h3>
                                <div class="tooltip ml-2">
                                    <i data-lucide="help-circle" class="w-4 h-4 text-gray-400"></i>
                                    <span class="tooltip-text">Select the primary goal of your application. This helps the AI choose the right architecture.</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <label><input type="radio" name="app-type" value="web-app" class="hidden" checked><div class="app-type-card p-4 rounded-lg cursor-pointer text-center h-full flex flex-col justify-center"><i data-lucide="layout-template" class="w-8 h-8 mx-auto mb-2"></i><span class="font-semibold text-sm">Web App</span></div></label>
                                <label><input type="radio" name="app-type" value="api-service" class="hidden"><div class="app-type-card p-4 rounded-lg cursor-pointer text-center h-full flex flex-col justify-center"><i data-lucide="server" class="w-8 h-8 mx-auto mb-2"></i><span class="font-semibold text-sm">API Service</span></div></label>
                                <label><input type="radio" name="app-type" value="ios-app" class="hidden"><div class="app-type-card p-4 rounded-lg cursor-pointer text-center h-full flex flex-col justify-center"><i data-lucide="smartphone" class="w-8 h-8 mx-auto mb-2"></i><span class="font-semibold text-sm">iOS App</span></div></label>
                                <label><input type="radio" name="app-type" value="android-app" class="hidden"><div class="app-type-card p-4 rounded-lg cursor-pointer text-center h-full flex flex-col justify-center"><i data-lucide="smartphone" class="w-8 h-8 mx-auto mb-2"></i><span class="font-semibold text-sm">Android App</span></div></label>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center mb-2">
                                <h3 class="text-lg font-semibold text-left">AI Configuration</h3>
                                <div class="tooltip ml-2"><i data-lucide="help-circle" class="w-4 h-4 text-gray-400"></i><span class="tooltip-text">Choose the number of AI agents working on your project in parallel. More workers can build faster but may increase costs.</span></div>
                            </div>
                             <label for="worker-slider" class="flex justify-between items-center text-gray-300"><span>AI Worker Agents</span><span id="worker-count" class="font-bold text-purple-400">3</span></label>
                            <input id="worker-slider" type="range" min="1" max="10" value="3" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer mt-2">
                        </div>
                    </div>
                    <!-- Right Column -->
                    <div>
                        <div class="flex items-center mb-3"><h3 class="text-lg font-semibold text-left">Core Features & Integrations</h3></div>
                        <div class="space-y-3">
                            <label class="flex items-center text-lg text-gray-300 cursor-pointer p-3 rounded-lg hover:bg-gray-800"><input type="checkbox" id="use-db" class="form-checkbox h-5 w-5 text-purple-600 bg-gray-800 border-gray-600 rounded focus:ring-purple-500"><span class="ml-4">Use a Database</span><div class="tooltip ml-auto"><i data-lucide="help-circle" class="w-4 h-4 text-gray-400"></i><span class="tooltip-text">Check this to give your application a persistent memory using a PostgreSQL database.</span></div></label>
                            <label class="flex items-center text-lg text-gray-300 cursor-pointer p-3 rounded-lg hover:bg-gray-800"><input type="checkbox" id="use-apis" class="form-checkbox h-5 w-5 text-purple-600 bg-gray-800 border-gray-600 rounded focus:ring-purple-500"><span class="ml-4">Use External APIs</span><div class="tooltip ml-auto"><i data-lucide="help-circle" class="w-4 h-4 text-gray-400"></i><span class="tooltip-text">Allows your application to connect to third-party services like social media, payment gateways, etc.</span></div></label>
                             <label class="flex items-center text-lg text-gray-300 cursor-pointer p-3 rounded-lg hover:bg-gray-800"><input type="checkbox" id="user-auth" class="form-checkbox h-5 w-5 text-purple-600 bg-gray-800 border-gray-600 rounded focus:ring-purple-500"><span class="ml-4">Add User Authentication</span><div class="tooltip ml-auto"><i data-lucide="help-circle" class="w-4 h-4 text-gray-400"></i><span class="tooltip-text">Enables user sign-up, login, and profile management for your application.</span></div></label>
                            <label class="flex items-center text-lg text-gray-300 cursor-pointer p-3 rounded-lg hover:bg-gray-800 bg-blue-500/10 border border-blue-500/30"><input type="checkbox" id="intensive-testing" class="form-checkbox h-5 w-5 text-purple-600 bg-gray-800 border-gray-600 rounded focus:ring-purple-500"><span class="ml-4">Intensive Testing</span><div class="tooltip ml-auto"><i data-lucide="help-circle" class="w-4 h-4 text-gray-400"></i><span class="tooltip-text">Each AI worker's output is individually verified. This increases reliability but costs more.</span></div></label>
                        </div>
                    </div>
                </div>

                <!-- Knowledge Base Upload -->
                <div class="mt-6 text-left">
                    <div class="flex items-center mb-3">
                        <h3 class="text-lg font-semibold">Knowledge Base</h3>
                        <div class="tooltip ml-2"><i data-lucide="help-circle" class="w-4 h-4 text-gray-400"></i><span class="tooltip-text">Upload documents, code, or images as context for the AI agents.</span></div>
                    </div>
                    <div id="dropzone" class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center cursor-pointer hover:border-purple-500 hover:bg-gray-800/50">
                        <i data-lucide="upload-cloud" class="w-10 h-10 mx-auto text-gray-500 mb-2"></i>
                        <p class="text-gray-400">Drag & drop files here or</p>
                        <button id="upload-btn" type="button" class="mt-2 text-purple-400 font-semibold">Browse files</button>
                        <input type="file" id="file-input" class="hidden" multiple>
                    </div>
                    <div id="file-list" class="mt-3 space-y-2"></div>
                </div>

                <button id="start-building-btn" class="mt-8 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform hover:scale-105">
                    Start Building
                </button>
            </div>
        </div>
    </template>

    <template id="template-chat">
        <div class="flex-1 flex flex-col h-full">
            <div id="chat-history" class="flex-1 space-y-6 overflow-y-auto pr-2"></div>
            <div class="mt-4 pt-4 border-t border-gray-700">
                <div class="glassmorphism rounded-lg p-2 flex items-center">
                    <textarea id="user-prompt" class="flex-grow bg-transparent p-2 focus:outline-none resize-none" rows="1" placeholder="Ask for a modification or new feature..."></textarea>
                    <button id="send-button" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold p-2 rounded-lg ml-2 transition-colors"><i data-lucide="send" class="w-5 h-5"></i></button>
                </div>
            </div>
        </div>
    </template>

    <template id="template-workflow">
        <div class="glassmorphism p-6 rounded-lg flex-1 flex flex-col">
            <h3 class="text-lg font-semibold mb-4 text-center">AI AGENT WORKFLOW</h3>
            <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="flex flex-col items-center justify-center">
                     <div id="workflow-visualization" class="relative flex items-center justify-between w-full max-w-sm mx-auto h-24">
                        <div id="node-manager" class="node z-10 w-20 h-20 rounded-full flex flex-col items-center justify-center bg-gray-700"><i data-lucide="user-cog" class="w-6 h-6 mb-1"></i><span class="text-xs">Manager</span></div>
                        <div id="node-retriever" class="node z-10 w-20 h-20 rounded-full flex flex-col items-center justify-center bg-gray-700"><i data-lucide="database" class="w-6 h-6 mb-1"></i><span class="text-xs">Retriever</span></div>
                        <div id="node-worker" class="node z-10 w-20 h-20 rounded-full flex flex-col items-center justify-center bg-gray-700"><i data-lucide="bot" class="w-6 h-6 mb-1"></i><span class="text-xs">Worker</span></div>
                        <div id="node-tester" class="node z-10 w-20 h-20 rounded-full flex flex-col items-center justify-center bg-gray-700"><i data-lucide="shield-check" class="w-6 h-6 mb-1"></i><span class="text-xs">Tester</span></div>
                        <div class="node-connector"></div>
                    </div>
                </div>
                <div class="flex flex-col">
                    <h4 class="font-semibold mb-3 text-center lg:text-left">Task Plan</h4>
                    <div id="task-plan-list" class="space-y-2 overflow-y-auto pr-2 bg-gray-900/50 p-3 rounded-lg h-64"></div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-700 text-center">
                <p class="text-gray-400 text-lg bg-gray-800 px-6 py-3 rounded-lg inline-block">STATUS: <span id="current-stage">Idle</span></p>
                <button id="deploy-btn" class="hidden mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-transform hover:scale-105"><i data-lucide="upload-cloud" class="inline-block -mt-1 mr-2 w-5 h-5"></i>Deploy Application</button>
            </div>
        </div>
    </template>

    <template id="template-preview">
        <div class="glassmorphism rounded-lg flex flex-col h-full">
            <div class="p-4 border-b border-gray-700 flex items-center"><i data-lucide="eye" class="w-5 h-5 mr-2"></i><h3 class="font-semibold">Live Preview</h3></div>
            <div id="preview-content" class="flex-1 p-4 bg-white/95 rounded-b-lg text-gray-800">
                <!-- Content changes based on app type -->
            </div>
        </div>
    </template>
    
    <template id="preview-webapp">
        <div class="w-full h-full flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg"><h2 class="text-xl font-bold mb-2">Marketing Strategy App</h2><p class="text-gray-500 mb-4">Your generated application preview will appear here.</p><button class="bg-purple-600 text-white py-2 px-4 rounded-lg">Get Started</button></div>
    </template>

    <template id="preview-api">
        <div class="font-mono text-sm h-full overflow-y-auto p-4 bg-gray-800 text-white rounded-lg">
            <h2 class="text-2xl font-bold mb-4 text-green-400">My API Service - Swagger UI</h2>
            <div class="space-y-4">
                <div class="bg-green-900/50 rounded"><div class="p-2 font-bold cursor-pointer"><span class="bg-green-500 text-white px-2 py-1 rounded-md text-xs mr-2">GET</span> /api/v1/users</div></div>
                <div class="bg-blue-900/50 rounded"><div class="p-2 font-bold cursor-pointer"><span class="bg-blue-500 text-white px-2 py-1 rounded-md text-xs mr-2">POST</span> /api/v1/users</div></div>
            </div>
            <p class="text-gray-400 mt-6 text-xs">* This is a mock-up of the Swagger/OpenAPI documentation that will be generated for your API.</p>
        </div>
    </template>

    <template id="preview-ios">
        <div class="w-full h-full flex flex-col items-center justify-center bg-gray-200 rounded-lg p-4">
            <div class="w-full max-w-xs bg-white rounded-3xl shadow-lg p-2">
                <div class="bg-black text-white rounded-t-2xl px-4 py-2 text-center font-bold">My iOS App</div>
                <div class="p-4 space-y-4">
                    <h3 class="text-lg font-semibold text-gray-800">Welcome!</h3>
                    <button class="w-full bg-blue-500 text-white py-2 rounded-lg">Log In</button>
                    <button class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg">Sign Up</button>
                </div>
            </div>
        </div>
    </template>

     <template id="preview-android">
        <div class="w-full h-full flex flex-col items-center justify-center bg-gray-200 rounded-lg p-4">
            <div class="w-full max-w-xs bg-white rounded-2xl shadow-lg">
                <div class="bg-teal-600 text-white p-4 rounded-t-2xl">
                    <h2 class="text-xl font-bold">My Android App</h2>
                </div>
                <div class="p-4 space-y-4">
                     <h3 class="text-lg font-semibold text-gray-800">Welcome!</h3>
                     <button class="w-full bg-purple-600 text-white py-2 rounded-md uppercase font-semibold shadow-md">Log In</button>
                     <button class="w-full border-2 border-purple-600 text-purple-600 py-2 rounded-md uppercase font-semibold">Sign Up</button>
                </div>
            </div>
        </div>
    </template>

    <template id="template-code">
        <div class="glassmorphism rounded-lg flex flex-col h-full">
            <div class="p-4 border-b border-gray-700 flex items-center"><i data-lucide="code-2" class="w-5 h-5 mr-2"></i><h3 class="font-semibold">Generated Code</h3></div>
            <div class="flex-1 p-4 bg-gray-900/50 rounded-b-lg font-mono text-sm overflow-y-auto"><pre><code id="generated-code" class="language-python"># Generated Python code will appear here.
# For example, using FastAPI...

from fastapi import FastAPI

app = FastAPI()

@app.get("/")
def read_root():
    return {"message": "Marketing Strategy App"}
            </code></pre></div>
        </div>
    </template>

    <template id="template-usage">
        <div class="glassmorphism rounded-lg flex flex-col h-full p-6 space-y-6">
            <div class="flex items-center"><i data-lucide="bar-chart-3" class="w-5 h-5 mr-2"></i><h3 class="font-semibold text-lg">Usage & Cost Analysis</h3></div>
            <div>
                <h4 class="text-md font-semibold mb-2 text-gray-300">Current Project Cost</h4>
                <div class="w-full bg-gray-700 rounded-full h-2.5"><div id="cost-progress" class="bg-blue-500 h-2.5 rounded-full" style="width: 45%"></div></div>
                <div class="flex justify-between text-sm mt-1"><span id="current-cost-label">$0.45</span><span class="text-gray-400">Est. Total: $1.00</span></div>
            </div>
            <div class="border-t border-gray-700 pt-6">
                 <h4 class="text-md font-semibold mb-3 text-gray-300">Estimated Monthly Maintenance</h4>
                 <div class="space-y-3">
                    <div class="flex justify-between items-center"><span class="text-gray-400">OpenAI API (GPT-4)</span><span class="font-semibold">$20.00 / month</span></div>
                    <div class="flex justify-between items-center"><span class="text-gray-400">Tavily Search API</span><span class="font-semibold">$10.00 / month</span></div>
                     <div class="flex justify-between items-center border-t border-gray-700 pt-3 mt-3"><span class="text-gray-300 text-lg">Total</span><span class="font-bold text-xl text-green-400">$30.00 / month</span></div>
                 </div>
            </div>
        </div>
    </template>

    <script>
        lucide.createIcons();

        // --- State and Core Logic ---
        const mainWorkspace = document.getElementById('main-workspace');
        const sidebarIcons = document.querySelectorAll('.sidebar-icon');
        const newProjectBtn = document.getElementById('new-project-btn');
        
        const templates = {
            newProject: document.getElementById('template-new-project').innerHTML,
            chat: document.getElementById('template-chat').innerHTML,
            workflow: document.getElementById('template-workflow').innerHTML,
            preview: document.getElementById('template-preview').innerHTML,
            code: document.getElementById('template-code').innerHTML,
            usage: document.getElementById('template-usage').innerHTML,
        };

        const projectState = {
            description: '',
            appType: '',
            useDb: false,
            useApis: false,
            userAuth: false,
            intensiveTesting: false,
            workerCount: 3,
            isComplete: false,
            uploadedFiles: [],
            chatHistory: [],
        };

        function switchPanel(panelName) {
            mainWorkspace.innerHTML = templates[panelName];
            lucide.createIcons();
            
            sidebarIcons.forEach(icon => {
                icon.classList.toggle('active', icon.dataset.panel === panelName);
            });
            
            addPanelEventListeners(panelName);

            if (panelName === 'workflow' && projectState.isComplete) {
                showCompletedWorkflow();
            }
            if (panelName === 'preview') {
                renderPreview();
            }
        }
        
        function renderPreview() {
            const previewContent = document.getElementById('preview-content');
            if (!previewContent) return;
            
            const previewTemplates = {
                'web-app': document.getElementById('preview-webapp').innerHTML,
                'api-service': document.getElementById('preview-api').innerHTML,
                'ios-app': document.getElementById('preview-ios').innerHTML,
                'android-app': document.getElementById('preview-android').innerHTML,
            };

            previewContent.innerHTML = previewTemplates[projectState.appType] || previewTemplates['web-app'];
            lucide.createIcons();
        }

        function addPanelEventListeners(panelName) {
            if (panelName === 'newProject') {
                document.getElementById('start-building-btn').addEventListener('click', startProject);
                const slider = document.getElementById('worker-slider');
                const count = document.getElementById('worker-count');
                slider.addEventListener('input', () => { count.textContent = slider.value; });
                
                // File upload listeners
                const dropzone = document.getElementById('dropzone');
                const fileInput = document.getElementById('file-input');
                const uploadBtn = document.getElementById('upload-btn');

                uploadBtn.addEventListener('click', () => fileInput.click());
                dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('border-purple-500'); });
                dropzone.addEventListener('dragleave', () => dropzone.classList.remove('border-purple-500'));
                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('border-purple-500');
                    handleFiles(e.dataTransfer.files);
                });
                fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

            } else if (panelName === 'chat') {
                document.getElementById('send-button')?.addEventListener('click', handleChatMessage);
                const userPrompt = document.getElementById('user-prompt');
                if(userPrompt) {
                    userPrompt.addEventListener('input', () => {
                        userPrompt.style.height = 'auto';
                        userPrompt.style.height = (userPrompt.scrollHeight) + 'px';
                    });
                }
                renderChatHistory();
            } else if (panelName === 'workflow') {
                document.getElementById('deploy-btn')?.addEventListener('click', () => alert('Deployment process initiated! (This is a simulation)'));
            }
        }

        function handleFiles(files) {
            const fileListEl = document.getElementById('file-list');
            for (const file of files) {
                if (!projectState.uploadedFiles.some(f => f.name === file.name)) {
                    projectState.uploadedFiles.push(file);
                    const fileEl = document.createElement('div');
                    fileEl.className = 'flex items-center p-2 bg-gray-800/50 rounded-md text-sm';
                    fileEl.innerHTML = `<i data-lucide="file" class="w-4 h-4 mr-2 text-gray-400"></i><span class="flex-1 truncate">${file.name}</span><button class="ml-2 text-gray-500 hover:text-white">&times;</button>`;
                    fileEl.querySelector('button').addEventListener('click', () => {
                        projectState.uploadedFiles = projectState.uploadedFiles.filter(f => f.name !== file.name);
                        fileEl.remove();
                    });
                    fileListEl.appendChild(fileEl);
                }
            }
            lucide.createIcons();
        }

        function startProject() {
            const description = document.getElementById('app-description').value;
            if (description.trim() === '') {
                alert('Please provide a description for your application.');
                return;
            }
            // Reset state for new project
            Object.assign(projectState, {
                description: description,
                appType: document.querySelector('input[name="app-type"]:checked').value,
                useDb: document.getElementById('use-db').checked,
                useApis: document.getElementById('use-apis').checked,
                userAuth: document.getElementById('user-auth').checked,
                intensiveTesting: document.getElementById('intensive-testing').checked,
                workerCount: document.getElementById('worker-slider').value,
                isComplete: false,
                chatHistory: [{
                    sender: 'system',
                    text: `Starting project: "${description}" (Type: ${document.querySelector('input[name="app-type"]:checked').value}, Workers: ${document.getElementById('worker-slider').value})`
                }]
            });
            
            runWorkflow();
        }

        function handleChatMessage() {
            const userPrompt = document.getElementById('user-prompt');
            if (userPrompt && userPrompt.value.trim() !== '') {
                projectState.chatHistory.push({ sender: 'user', text: userPrompt.value });
                projectState.isComplete = false;
                runWorkflow();
                userPrompt.value = '';
            }
        }

        function renderChatHistory() {
            const chatHistoryEl = document.getElementById('chat-history');
            if (!chatHistoryEl) return;
            chatHistoryEl.innerHTML = '';
            projectState.chatHistory.forEach(msg => {
                const msgEl = document.createElement('div');
                if (msg.sender === 'user') {
                    msgEl.className = 'flex items-start gap-4 justify-end';
                    msgEl.innerHTML = `<div class="glassmorphism p-4 rounded-lg max-w-2xl bg-purple-600/20 border-purple-500/50"><p>${msg.text}</p></div><img src="https://placehold.co/40x40/ffffff/1f2937?text=U" alt="User Avatar" class="rounded-full">`;
                } else {
                     msgEl.className = 'flex items-start gap-4';
                     msgEl.innerHTML = `<img src="https://placehold.co/40x40/7c3aed/ffffff?text=A" alt="AI Avatar" class="rounded-full"><div class="glassmorphism p-4 rounded-lg max-w-2xl"><p>${msg.text}</p></div>`;
                }
                chatHistoryEl.appendChild(msgEl);
            });
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }


        // --- Workflow Simulation ---
        const mockTasks = [
            { name: "Define Database Schema", agent: "Worker" },
            { name: "Set up FastAPI server", agent: "Worker" },
            { name: "Create API endpoint for user registration", agent: "Worker" },
            { name: "Build frontend login form", agent: "Worker" },
            { name: "Write unit tests for API", agent: "Tester" }
        ];

        const stages = [
            { name: 'manager', duration: 1000, text: 'Manager: Analyzing request...' },
            { name: 'retriever', duration: 1000, text: 'Retriever: Searching knowledge base...' },
            { name: 'worker', duration: 3000, text: 'Worker: Executing tasks...' },
            { name: 'tester', duration: 1500, text: 'Tester: Validating final output...' },
        ];

        function populateTaskPlan() {
            const taskListEl = mainWorkspace.querySelector('#task-plan-list');
            if (!taskListEl) return;
            taskListEl.innerHTML = '';
            mockTasks.forEach((task, index) => {
                const taskEl = document.createElement('div');
                taskEl.id = `task-${index}`;
                taskEl.className = 'task-item flex items-center p-2 rounded-md bg-gray-800/50';
                taskEl.innerHTML = `<i data-lucide="clock" class="task-status-icon w-5 h-5 mr-3 text-gray-500"></i><div class="flex-1"><p class="font-medium">${task.name}</p><p class="text-xs text-gray-400">Agent: ${task.agent}</p></div>`;
                taskListEl.appendChild(taskEl);
            });
            lucide.createIcons();
        }

        async function updateTaskStatus(index, status) {
            const taskEl = mainWorkspace.querySelector(`#task-${index}`);
            if (!taskEl) return;
            const iconEl = taskEl.querySelector('.task-status-icon');
            if (!iconEl) return;
            let iconName = 'clock';
            let iconColor = 'text-gray-500';
            if (status === 'running') {
                iconName = 'loader-2';
                iconColor = 'text-blue-500 animate-spin';
            } else if (status === 'completed') {
                iconName = 'check-circle-2';
                iconColor = 'text-green-500';
            }
            iconEl.outerHTML = `<i data-lucide="${iconName}" class="task-status-icon w-5 h-5 mr-3 ${iconColor}"></i>`;
            lucide.createIcons();
        }

        async function runWorkflow() {
            switchPanel('workflow');
            await new Promise(r => setTimeout(r, 50));

            const { nodes, currentStageSpan } = getWorkflowElements();
            if (!currentStageSpan) return;

            Object.values(nodes).forEach(node => node?.classList.remove('running', 'completed', 'failed'));
            document.getElementById('deploy-btn')?.classList.add('hidden');
            
            populateTaskPlan();

            // Manager & Retriever
            currentStageSpan.textContent = stages[0].text;
            nodes.manager.classList.add('running');
            await new Promise(r => setTimeout(r, stages[0].duration));
            nodes.manager.classList.remove('running');
            nodes.manager.classList.add('completed');

            currentStageSpan.textContent = stages[1].text;
            nodes.retriever.classList.add('running');
            await new Promise(r => setTimeout(r, stages[1].duration));
            nodes.retriever.classList.remove('running');
            nodes.retriever.classList.add('completed');
            
            // Worker executes tasks
            currentStageSpan.textContent = stages[2].text;
            nodes.worker.classList.add('running');
            for (let i = 0; i < mockTasks.length; i++) {
                if (mockTasks[i].agent === 'Worker') {
                    await updateTaskStatus(i, 'running');
                    await new Promise(r => setTimeout(r, stages[2].duration / mockTasks.filter(t=>t.agent==='Worker').length));
                    await updateTaskStatus(i, 'completed');
                }
            }
            nodes.worker.classList.remove('running');
            nodes.worker.classList.add('completed');

            // Tester executes tasks
            currentStageSpan.textContent = stages[3].text;
            nodes.tester.classList.add('running');
            for (let i = 0; i < mockTasks.length; i++) {
                if (mockTasks[i].agent === 'Tester') {
                    await updateTaskStatus(i, 'running');
                    await new Promise(r => setTimeout(r, stages[3].duration / mockTasks.filter(t=>t.agent==='Tester').length));
                    await updateTaskStatus(i, 'completed');
                }
            }
            nodes.tester.classList.remove('running');
            nodes.tester.classList.add('completed');


            projectState.isComplete = true;
            showCompletedWorkflow();
            projectState.chatHistory.push({ sender: 'system', text: 'I have finished the build. You can see the result in the "Preview" tab or deploy from the "Workflow" tab.' });
        }
        
        function showCompletedWorkflow() {
            const { nodes, currentStageSpan, deployBtn } = getWorkflowElements();
            if (!currentStageSpan) return;
            currentStageSpan.textContent = 'Build Complete! Ready to Deploy.';
            Object.values(nodes).forEach(node => node?.classList.add('completed'));
            document.getElementById('deploy-btn')?.classList.remove('hidden');
            
            populateTaskPlan();
            mockTasks.forEach((_, index) => updateTaskStatus(index, 'completed'));
        }

        function getWorkflowElements() {
             return {
                nodes: {
                    manager: mainWorkspace.querySelector('#node-manager'),
                    retriever: mainWorkspace.querySelector('#node-retriever'),
                    worker: mainWorkspace.querySelector('#node-worker'),
                    tester: mainWorkspace.querySelector('#node-tester'),
                },
                currentStageSpan: mainWorkspace.querySelector('#current-stage'),
                deployBtn: mainWorkspace.querySelector('#deploy-btn'),
            };
        }

        // --- Initial Load ---
        newProjectBtn.addEventListener('click', () => switchPanel('newProject'));
        sidebarIcons.forEach(icon => {
            icon.addEventListener('click', () => {
                if (projectState.description === '' && icon.dataset.panel !== 'newProject') {
                    alert('Please start a new project first.');
                    return;
                }
                switchPanel(icon.dataset.panel)
            });
        });
        
        switchPanel('newProject');

    </script>
</body>
</html>
